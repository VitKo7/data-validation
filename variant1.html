<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6"
      crossorigin="anonymous"
    />
    <title>User Verification, Variant #1</title>
    <link rel="stylesheet" href="./styles.css" />
  </head>

  <body>
    <!-- <noscript>You need to enable JavaScript to run this app.</noscript>
    <div id="root"></div> -->

    <!-- ! variant-1 -->
    <div id="dataArea">
      <div id="panel">
        <input type="file" name="readable" accept=".csv" />
      </div>

      <div id="preview"></div>
    </div>

    <script type="text/javascript">
      // Элемент для выбора файлов.
      const INPUT = document.querySelector('input[name="readable"]');
      // Элемент для вывода сгенерированной таблицы.
      const PREVIEW = document.querySelector('#preview');
      // Регулярное выражение для проверки расширения файла.
      const REGEX = new RegExp('(.*?)\.(csv)$', 'i');

      // Функция, отрабатывающая при выборе файла.
      function handleFile(event) {
        // Выбираем первый файл из списка файлов.
        const file = event.target.files[0];

        // Если файл выбран и его расширение допустимо,
        // то читаем его содержимое и отправляем
        // в функцию отрисовки таблицы.
        if (file && REGEX.test(file.name)) {
          // Создаем экземпляр объекта.
          const reader = new FileReader();

          // Чтение файла асинхронное, поэтому
          // создание таблицы привязываем к событию `load`,
          // которое срабатывает при успешном завершении операции чтения.
          reader.onload = e => renderTable(e.target.result);

          // Читаем содержимое как текстовый файл.
          reader.readAsText(file);
        } else {
          // Мизерная обработка ошибок.
          console.error(`Произошла ошибка при попытке открыть файл ${file}`);
          alert('Файл не выбран либо его формат не поддерживается.');
          event.target.value = '';
        }
      }

      // Функция отрисовки таблицы.
      function renderTable(data) {
        // Предварительно создадим элементы,
        // отвечающие за каркас таблицы.
        let table = document.createElement('table');
        let thead = document.createElement('thead');
        let tbody = document.createElement('tbody');

        // Добавим класс к таблице.
        table.classList.add('table');

        // Разбиваем входящие данные построчно.
        // Разделитель - перенос строки.
        // Перебираем полученный массив строк.
        data.split(/\r\n|\r|\n/).forEach(function (row, index) {
          // Создадим элемент строки для таблицы.
          let trow = document.createElement('tr');

          // Разбиваем каждую строку на ячейку.
          // Разделитель - точка с запятой.
          // Перебираем полученный массив будущих ячеек.
          row.split(/;/).forEach(function (cell) {
            // Создадим элемент ячейки для таблицы.
            let tcell = document.createElement(index > 0 ? 'td' : 'th');
            // Заполним содержимое ячейки.
            tcell.textContent = cell;
            // Добавляем ячейку к родительской строке.
            trow.appendChild(tcell);
          });

          // Добавляем строку к родительскому элементу.
          // Если индекс строки больше нуля,
          // то родительский элемент - `tbody`,
          // в противном случае- `thead`.
          index > 0 ? tbody.appendChild(trow) : thead.appendChild(trow);
        });

        // Добавляем заголовок таблицы к родительскому элементу.
        table.appendChild(thead);
        // Добавляем тело таблицы к родительскому элементу.
        table.appendChild(tbody);

        // Очищаем элемент для вывода таблицы.
        PREVIEW.innerHTML = '';
        // Добавляем саму таблицу к родительскому элементу.
        PREVIEW.appendChild(table);
      }

      // Регистрируем функцию обработчика события `change`,
      // срабатывающего при изменении элемента выбора файла.
      INPUT.addEventListener('change', handleFile);
    </script>

    <!-- ! variant-2 -->
    <!-- <div id="dragArea">
      <div id="panel">This browser doesnt support the File API</div>
      <div id="content"></div>
      <div id="console"></div>
    </div>

    <script
      type="text/javascript"
      src="https://code.jquery.com/jquery-2.2.4.min.js"
      integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44="
      crossorigin="anonymous"
    ></script>

    <script type="text/javascript">
      function CSVToArray(strData, strDelimiter) {
        // Check to see if the delimiter is defined. If not,
        // then default to comma.
        strDelimiter = strDelimiter || ';';

        // Create a regular expression to parse the CSV values.
        var objPattern = new RegExp(
          // Delimiters.
          '(\\' +
            strDelimiter +
            '|\\r?\\n|\\r|^)' +
            // Quoted fields.
            '(?:"([^"]*(?:""[^"]*)*)"|' +
            // Standard fields.
            '([^"\\' +
            strDelimiter +
            '\\r\\n]*))',
          'gi',
        );

        // Create an array to hold our data. Give the array
        // a default empty first row.
        var arrData = [[]];

        // Create an array to hold our individual pattern
        // matching groups.
        var arrMatches = null;

        // Keep looping over the regular expression matches
        // until we can no longer find a match.
        while ((arrMatches = objPattern.exec(strData))) {
          // Get the delimiter that was found.
          var strMatchedDelimiter = arrMatches[1];

          // Check to see if the given delimiter has a length
          // (is not the start of string) and if it matches
          // field delimiter. If id does not, then we know
          // that this delimiter is a row delimiter.
          if (
            strMatchedDelimiter.length &&
            strMatchedDelimiter != strDelimiter
          ) {
            // Since we have reached a new row of data,
            // add an empty row to our data array.
            arrData.push([]);
          }

          // Now that we have our delimiter out of the way,
          // let's check to see which kind of value we
          // captured (quoted or unquoted).
          if (arrMatches[2]) {
            // We found a quoted value. When we capture
            // this value, unescape any double quotes.
            var strMatchedValue = arrMatches[2].replace(
              new RegExp('""', 'g'),
              '"',
            );
          } else {
            // We found a non-quoted value.
            var strMatchedValue = arrMatches[3];
          }

          // Now that we have our value string, let's add
          // it to the data array.
          arrData[arrData.length - 1].push(strMatchedValue);
        }

        // Return the parsed data.
        return arrData;
      }

      function iterator(files) {
        if (files.length) {
          for (var i = 0; i < files.length; i++) {
            readFileAsText(files[i]);
          }
        }
      }

      function readFileAsText(file) {
        var reader = new FileReader();
        reader.onload = function (event) {
          var csvValue = event.target.result;
          console.log(CSVToArray(event.target.result));
          $('#content').append(event.target.result);
        };
        reader.onerror = function () {
          $('#content').append('Unable to read ' + file.fileName + '\r\n');
        };
        // or UTF-8
        reader.readAsText(file, 'ISO-8859-1');
        // reader.readAsArrayBuffer(file);
      }

      http: if (window.FileReader) {
        var $content = $('content');

        $('#panel').html(
          '<p>Pick a text file or drag one into this area</p>' +
            '<p><input type="file" id="file" multiple="true"  /></p>',
        );

        // Input handler
        $('#file').on('change', function () {
          iterator(this.files);
        });

        // Drag and drop methods
        $('#dragArea').on({
          dragover: function (event) {
            event.preventDefault();
            return false;
          },
          drop: function (event) {
            event.stopPropagation();
            readFileAsText(event.dataTransfer.files[0]);
            return false;
          },
        });
      }
    </script> -->

    <!-- ! variant-3 -->
    <!-- <script src="https://raw.githubusercontent.com/mholt/PapaParse/master/papaparse.min.js"></script>
    <script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>

    <script>
      let data;

      function handleFileSelect(evt) {
        let file = evt.target.files[0];

        Papa.parse(file, {
          // delimiter:";"
          header: true,
          dynamicTyping: true,
          complete: function (results) {
            data = results;
          },
        });
      }

      $(document).ready(function () {
        $('#csv-file').change(handleFileSelect);
      });
    </script>
    <input type="file" id="csv-file" name="files" /> -->
  </body>
</html>
